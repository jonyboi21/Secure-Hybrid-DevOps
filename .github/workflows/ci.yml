name: Secure Hybrid CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: secure-hybrid/api

jobs:
  lint_test_security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: App
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pytest ruff pip-audit

      - name: Lint (ruff)
        working-directory: App
        run: ruff check .

      - name: Unit tests
        working-directory: App
        run: pytest -q

      - name: Dependency vulnerability scan (pip-audit)
        working-directory: App
        run: pip-audit -r requirements.txt

  build_scan:
    runs-on: ubuntu-latest
    needs: [lint_test_security]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local) for scanning
        run: |
          docker build -t ${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Trivy image scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: table
          exit-code: "1"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

      - name: Job summary (CI)
        run: |
          {
            echo "## CI"
            echo ""
            echo "- Image built: \`${{ env.IMAGE_NAME }}:${{ github.sha }}\`"
            echo "- Trivy: **HIGH/CRITICAL blocked**"
          } >> "$GITHUB_STEP_SUMMARY"

  build_push_acr:
    runs-on: ubuntu-latest
    needs: [build_scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      # Determine whether Azure secrets are present; set outputs
      - name: Check Azure secrets present
        id: azcheck
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ACR_NAME: ${{ secrets.ACR_NAME }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          missing=0
          for v in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID ACR_NAME ACR_LOGIN_SERVER; do
            if [ -z "${!v}" ]; then
              echo "Missing secret: $v"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip Azure (no secrets configured)
        if: steps.azcheck.outputs.enabled != 'true'
        run: |
          echo "Azure credentials/secrets not configured. Skipping ACR push."
          exit 0

      - name: Azure login (OIDC)
        if: steps.azcheck.outputs.enabled == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR login
        if: steps.azcheck.outputs.enabled == 'true'
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        if: steps.azcheck.outputs.enabled == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build and push image to ACR
        if: steps.azcheck.outputs.enabled == 'true'
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Job summary (ACR push)
        if: steps.azcheck.outputs.enabled == 'true'
        run: |
          {
            echo "## ACR Push"
            echo ""
            echo "- Image: \`${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy_aks:
    runs-on: ubuntu-latest
    needs: [build_push_acr]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check Azure secrets present
        id: azcheck
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
          AKS_NAME: ${{ secrets.AKS_NAME }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        run: |
          missing=0
          for v in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID AKS_RESOURCE_GROUP AKS_NAME ACR_LOGIN_SERVER; do
            if [ -z "${!v}" ]; then
              echo "Missing secret: $v"
              missing=1
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip Azure (no secrets configured)
        if: steps.azcheck.outputs.enabled != 'true'
        run: |
          echo "Azure credentials/secrets not configured. Skipping AKS deploy."
          exit 0

      - name: Azure login (OIDC)
        if: steps.azcheck.outputs.enabled == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS context
        if: steps.azcheck.outputs.enabled == 'true'
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: Install kubectl
        if: steps.azcheck.outputs.enabled == 'true'
        uses: azure/setup-kubectl@v4

      - name: Deploy manifests (patch image + tag)
        if: steps.azcheck.outputs.enabled == 'true'
        run: |
          kubectl apply -f k8s/namespace.yaml
          sed -e "s|REPLACE_ME_ACR_LOGIN_SERVER|${{ secrets.ACR_LOGIN_SERVER }}|g" \
              -e "s|REPLACE_ME_TAG|${{ github.sha }}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: Wait for rollout
        if: steps.azcheck.outputs.enabled == 'true'
        run: kubectl -n secure-hybrid rollout status deploy/api --timeout=180s

      - name: Deploy summary
        if: steps.azcheck.outputs.enabled == 'true'
        run: |
          {
            echo "## Deploy"
            echo ""
            echo "- Namespace: \`secure-hybrid\`"
            echo "- Deployment: \`api\`"
            echo "- Tag: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"