name: Secure Hybrid CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

#concurrency:
#  group: ${{ github.workflow }}-${{ github.ref }}
#  cancel-in-progress: true

env:
  IMAGE_NAME: secure-hybrid/api

jobs:
  lint_test_security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        working-directory: App
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest ruff pip-audit httpx

      # Debug step (safe: no heredoc)
      - name: Debug runner state
        run: |
          echo "SHA=$GITHUB_SHA REF=$GITHUB_REF"
          echo "PWD=$(pwd)"
          ls -la
          echo "---- workflows ----"
          ls -la .github/workflows
          echo "---- App tree ----"
          ls -la App
          ls -la App/tests
          echo "---- App/tests/test_health.py (first 40 lines) ----"
          sed -n '1,40p' App/tests/test_health.py
          echo "---- search for old import anywhere ----"
          grep -R "from app\.main import app" -n . || true
          echo "---- python sys.path ----"
          python -c "import os,sys; print('cwd:', os.getcwd()); print('sys.path:'); [print('  ',p) for p in sys.path]"

      - name: Lint (ruff)
        working-directory: App
        run: ruff check .

      - name: Unit tests (verbose)
        env:
          PYTHONPATH: ${{ github.workspace }}/App
        run: |
          python -V
          pytest -vv --maxfail=1 --full-trace --showlocals -s App/tests

      - name: Dependency vulnerability scan (pip-audit)
        working-directory: App
        run: pip-audit -r requirements.txt

  build_scan_push:
    runs-on: ubuntu-latest
    needs: [lint_test_security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local) for scanning
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Trivy image scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: table
          exit-code: "1"
          severity: "HIGH,CRITICAL"
          ignore-unfixed: true

      - name: Push image to ACR
        run: |
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Job summary
        run: |
          {
            echo "## Build/Scan/Push"
            echo ""
            echo "- Image: \`${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`"
            echo "- Trivy: **HIGH/CRITICAL blocked**"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy_aks:
    runs-on: ubuntu-latest
    needs: [build_scan_push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_NAME }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Deploy manifests (patch image + tag)
        run: |
          kubectl apply -f k8s/namespace.yaml
          sed -e "s|REPLACE_ME_ACR_LOGIN_SERVER|${{ secrets.ACR_LOGIN_SERVER }}|g" \
              -e "s|REPLACE_ME_TAG|${{ github.sha }}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: Wait for rollout
        run: kubectl -n secure-hybrid rollout status deploy/api --timeout=180s

      - name: Deploy summary
        run: |
          {
            echo "## Deploy"
            echo ""
            echo "- Namespace: \`secure-hybrid\`"
            echo "- Deployment: \`api\`"
            echo "- Tag: \`${{ github.sha }}\`"
          } >> "$GITHUB_STEP_SUMMARY"